<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>{{ player.name }} | Detay</title>
    <style>
        .pitch { background: #387032; border: 2px solid rgba(255,255,255,0.2); position: relative; width: 100%; height: 250px; border-radius: 15px; overflow: hidden; background-image: linear-gradient(to bottom, transparent 49%, rgba(255,255,255,0.1) 50%); background-size: 100% 40px; }
        .pitch-center { position: absolute; top: 50%; left: 50%; width: 60px; height: 60px; border: 1px solid rgba(255,255,255,0.2); border-radius: 50%; transform: translate(-50%, -50%); }
        .pos-marker { position: absolute; transform: translate(-50%, -50%); display: flex; flex-direction: column; align-items: center; transition: all 0.5s; }
        .dot { width: 12px; height: 12px; border-radius: 50%; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        .dot-label { font-size: 8px; font-weight: 900; margin-top: 2px; text-transform: uppercase; white-space: nowrap; padding: 1px 4px; border-radius: 4px; }
    </style>
</head>
<body class="bg-[#0b0f1a] text-white p-4">
    <div class="max-w-4xl mx-auto">
        <header class="py-4"><a href="/?sifre={{ sifre }}" class="text-slate-500 font-black text-[10px] uppercase">‚Üê Piyasaya D√∂n</a></header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-6">
            <div class="bg-[#161b2a] p-10 rounded-[3rem] text-center border border-slate-800">
                <div id="displayNation" class="text-[20px] mb-2">üáπüá∑</div> <img src="{{ player.img }}" class="h-56 mx-auto object-contain mb-6">
                <h1 id="displayName" class="text-4xl font-black italic tracking-tighter">{{ player.name }}</h1>
                <p id="displayClubPos" class="text-blue-500 font-bold mb-4 uppercase text-[10px]">{{ player.club }} | {{ player.position }}</p>
                <div id="displayValue" class="bg-blue-600 p-4 rounded-2xl text-2xl font-black italic">{{ player.value }} M ‚Ç¨</div>
                
                <div class="grid grid-cols-3 gap-2 mt-6 border-t border-slate-800 pt-6">
                    <div class="text-center"><p class="text-[7px] text-slate-500">Lƒ∞GDE</p><p id="rankLig" class="font-black text-xs text-blue-400">#--</p></div>
                    <div class="text-center"><p class="text-[7px] text-slate-500">TAKIMDA</p><p id="rankTakim" class="font-black text-xs text-green-400">#--</p></div>
                    <div class="text-center"><p class="text-[7px] text-slate-500">MEVKƒ∞DE</p><p id="rankMevki" class="font-black text-xs text-yellow-400">#--</p></div>
                </div>
            </div>

            <div class="bg-[#161b2a] p-6 rounded-[2rem] border border-slate-800">
                <h3 class="text-white font-black mb-4 uppercase text-[9px] text-center italic">Saha Dizilimi</h3>
                <div class="pitch">
                    <div class="pitch-center"></div>
                    <div id="mainPosBox" class="pos-marker">
                        <div class="dot bg-white"></div>
                        <span id="mainLabel" class="dot-label bg-white text-black">---</span>
                    </div>
                    <div id="subPosBox" class="pos-marker">
                        <div class="dot bg-blue-500"></div>
                        <span id="subLabel" class="dot-label bg-blue-500 text-white">---</span>
                    </div>
                </div>
                <div class="mt-6"><canvas id="chart"></canvas></div>
            </div>
        </div>

        {% if is_admin %}
        <div class="mt-10 bg-[#161b2a] p-6 rounded-[2rem] border-2 border-dashed border-blue-500 mb-10 text-black">
            <h3 class="text-blue-500 font-black mb-6 uppercase text-center text-[10px]">Geli≈ümi≈ü Veri Giri≈üi</h3>
            <form id="editForm" class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <input type="text" id="editName" class="p-3 rounded-xl text-xs font-bold" placeholder="ƒ∞sim">
                <input type="text" id="editClub" class="p-3 rounded-xl text-xs font-bold" placeholder="Kul√ºp">
                <input type="text" id="editNation" class="p-3 rounded-xl text-xs font-bold" placeholder="√úlke Bayraƒüƒ± (Emoji)">
                <input type="text" id="editValue" class="p-3 rounded-xl text-xs font-bold" placeholder="Deƒüer (M)">
                
                <input type="text" id="editPos" class="p-3 rounded-xl text-xs font-bold" placeholder="Ana Mevki">
                <input type="number" id="editX" class="p-3 rounded-xl text-xs font-bold" placeholder="Ana X (0-100)">
                <input type="number" id="editY" class="p-3 rounded-xl text-xs font-bold" placeholder="Ana Y (0-100)">
                
                <input type="text" id="editSubPos" class="p-3 rounded-xl text-xs font-bold" placeholder="Yan Mevki">
                <input type="number" id="editSubX" class="p-3 rounded-xl text-xs font-bold" placeholder="Yan X (0-100)">
                <input type="number" id="editSubY" class="p-3 rounded-xl text-xs font-bold" placeholder="Yan Y (0-100)">
                
                <button type="button" onclick="saveChanges()" class="col-span-2 md:col-span-4 bg-blue-600 text-white font-black py-4 rounded-2xl">KAYDET VE SIRALAMAYI HESAPLA</button>
            </form>
        </div>
        {% endif %}
    </div>

    <script>
        const currentId = "{{ player.id }}";
        
        function updateDisplay() {
            const players = JSON.parse(localStorage.getItem('players')) || [];
            const p = players.find(x => String(x.id) === String(currentId));
            
            if(p) {
                // Saha Pozisyonlarƒ±
                document.getElementById('mainPosBox').style.left = (p.posX || 50) + "%";
                document.getElementById('mainPosBox').style.top = (p.posY || 50) + "%";
                document.getElementById('mainLabel').innerText = p.position;

                document.getElementById('subPosBox').style.left = (p.subX || 60) + "%";
                document.getElementById('subPosBox').style.top = (p.subY || 60) + "%";
                document.getElementById('subLabel').innerText = p.subPosition || "---";

                document.getElementById('displayNation').innerText = p.nation || "üáπüá∑";
                document.getElementById('displayName').innerText = p.name;
                document.getElementById('displayValue').innerText = p.marketValue + " M ‚Ç¨";

                // SIRALAMA HESAPLAMA
                const sortedAll = [...players].sort((a,b) => b.marketValue - a.marketValue);
                const rankLig = sortedAll.findIndex(x => x.id === currentId) + 1;
                
                const sortedTeam = players.filter(x => x.club === p.club).sort((a,b) => b.marketValue - a.marketValue);
                const rankTakim = sortedTeam.findIndex(x => x.id === currentId) + 1;

                const sortedPos = players.filter(x => x.position === p.position).sort((a,b) => b.marketValue - a.marketValue);
                const rankMevki = sortedPos.findIndex(x => x.id === currentId) + 1;

                document.getElementById('rankLig').innerText = "#" + rankLig;
                document.getElementById('rankTakim').innerText = "#" + rankTakim;
                document.getElementById('rankMevki').innerText = "#" + rankMevki;

                // Formu Doldur
                if(document.getElementById('editName')) {
                    document.getElementById('editName').value = p.name;
                    document.getElementById('editPos').value = p.position;
                    document.getElementById('editX').value = p.posX;
                    document.getElementById('editY').value = p.posY;
                    document.getElementById('editSubPos').value = p.subPosition;
                    document.getElementById('editSubX').value = p.subX;
                    document.getElementById('editSubY').value = p.subY;
                    document.getElementById('editNation').value = p.nation;
                }
            }
        }

        function saveChanges() {
            let players = JSON.parse(localStorage.getItem('players')) || [];
            let idx = players.findIndex(x => String(x.id) === String(currentId));
            
            let obj = idx !== -1 ? players[idx] : { id: currentId };
            
            obj.name = document.getElementById('editName').value;
            obj.club = document.getElementById('editClub').value;
            obj.marketValue = parseFloat(document.getElementById('editValue').value);
            obj.position = document.getElementById('editPos').value;
            obj.posX = document.getElementById('editX').value;
            obj.posY = document.getElementById('editY').value;
            obj.subPosition = document.getElementById('editSubPos').value;
            obj.subX = document.getElementById('editSubX').value;
            obj.subY = document.getElementById('editSubY').value;
            obj.nation = document.getElementById('editNation').value;

            if(idx !== -1) players[idx] = obj; else players.push(obj);
            localStorage.setItem('players', JSON.stringify(players));
            location.reload();
        }

        document.addEventListener('DOMContentLoaded', updateDisplay);
    </script>
</body>
</html>
